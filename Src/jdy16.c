#include "jdy16.h"

uint8_t BT_NAME[] = {0x41,0x54,0x2B, 0x4E, 0x41, 0x4D, 0x45, 0x45, 0x59, 0x45, 0x42, 0x4F, 0x41, 0x52, 0x44, 0x0D, 0x0A};
uint8_t UUID_Service[] = {0x41,0x54,0x2B,0x53,0x56,0x52,0x55,0x55,0x49,0x44,0x00,0x00,0xff,0x00,0x00,0x00,0x10,0x00,0x80,0x00,0x00,0x80,0x5f,0x9b,0x34,0xfb,0x0d,0x0a};
uint8_t UUID_uuid1[] = {0x41,0x54,0x2B,0x43,0x48,0x52,0x55,0x55,0x49,0x44,0x00,0x00,0xff,0x02,0x00,0x00,0x10,0x00,0x80,0x00,0x00,0x80,0x5f,0x9b,0x34,0xfb,0x0d,0x0a};
uint8_t UUID_uuid2[] = {0x41,0x54,0x2B,0x43,0x52,0x58,0x55,0x55,0x49,0x44,0x00,0x00,0xff,0x01,0x00,0x00,0x10,0x00,0x80,0x00,0x00,0x80,0x5f,0x9b,0x34,0xfb,0x0d,0x0a};	
uint8_t AT_SVR[] = {0x41,0x54,0x2B,0x53,0x56,0x52,0x55,0x55,0x49,0x44,0x0d,0x0a};
uint8_t AT_CHR[] = {0x41,0x54,0x2b,0x43,0x48,0x52,0x55,0x55,0x49,0x44,0x0d,0x0a};
uint8_t AT_CRX[] = {0x41,0x54,0x2b,0x43,0x52,0x58,0x55,0x55,0x49,0x44,0x0d,0x0a};
uint8_t AT_ADVIN0[] = {0x41,0x54,0x2b,0x41,0x44,0x56,0x49,0x4e,0x30,0x0d,0x0a};
uint8_t AT_BAUD[] = {0x41,0x54,0x2b,0x42,0x41,0x55,0x44,0x38,0x0d,0x0a};

void JDY16_init(UART_HandleTypeDef huart1)
{
	BT_Reset();
	EnterToAtMode();
	HAL_Delay(500);
	
	BT_SetUUID(huart1);
	HAL_Delay(200);
	HAL_UART_Transmit(&huart1, BT_NAME, sizeof(BT_NAME), 100);
	HAL_Delay(200);
	HAL_UART_Transmit(&huart1, AT_SVR, sizeof(AT_SVR), 100);
	HAL_Delay(100);
	HAL_UART_Transmit(&huart1, AT_CHR, sizeof(AT_CHR), 100);
	HAL_Delay(100);
	HAL_UART_Transmit(&huart1, AT_CRX, sizeof(AT_CRX), 100);
	HAL_Delay(100);
	HAL_UART_Transmit(&huart1, AT_ADVIN0, sizeof(AT_ADVIN0), 100);
	HAL_Delay(100);
	HAL_UART_Transmit(&huart1, AT_BAUD, sizeof(AT_BAUD), 100);
	HAL_Delay(100);

	EnterToComMode();
}
void EnterToAtMode(void)
{
	HAL_GPIO_WritePin(GPIOB, GPIO_PIN_4, GPIO_PIN_RESET);
	HAL_Delay(100);
}
void EnterToComMode(void)
{
	HAL_GPIO_WritePin(GPIOB, GPIO_PIN_4, GPIO_PIN_SET);
	HAL_Delay(100);
}


void BT_Reset(void)
{
	HAL_GPIO_WritePin(GPIOB, GPIO_PIN_3, GPIO_PIN_RESET);
	HAL_Delay(1000);
	HAL_GPIO_WritePin(GPIOB, GPIO_PIN_3, GPIO_PIN_SET);
	HAL_Delay(100);
}

uint8_t BT_IsConnected(void)
{
	if(HAL_GPIO_ReadPin(GPIOB, GPIO_PIN_5))
	{
		return 0xff;
	}else
	{
		return 0;
	}
}

void BT_Send(uint8_t* data, UART_HandleTypeDef huart1)
{
	HAL_UART_Transmit(&huart1, data, sizeof(data), 100);
	HAL_Delay(200);
}

void BT_SetUUID(UART_HandleTypeDef huart1)
{
	HAL_UART_Transmit(&huart1, UUID_Service, sizeof(UUID_Service), 100);
	HAL_Delay(200);
	HAL_UART_Transmit(&huart1, UUID_uuid1, sizeof(UUID_uuid1), 100);
	HAL_Delay(200);
	HAL_UART_Transmit(&huart1, UUID_uuid2, sizeof(UUID_uuid2), 100);
}

void BT_SetNAME(UART_HandleTypeDef huart1)
{
	HAL_UART_Transmit(&huart1, BT_NAME, sizeof(BT_NAME), 100);
}